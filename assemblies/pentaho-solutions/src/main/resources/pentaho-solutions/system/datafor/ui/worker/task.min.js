"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,a)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"===_typeof(r)?r:String(r)}function _toPrimitive(e,r){if("object"!==_typeof(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var a=t.call(e,r||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var a,n,o,i,l=[],u=!0,s=!1;try{if(o=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;u=!1}else for(;!(u=(a=o.call(t)).done)&&(l.push(a.value),l.length!==r);u=!0);}catch(e){s=!0,n=e}finally{try{if(!u&&null!=t.return&&(i=t.return(),Object(i)!==i))return}finally{if(s)throw n}}return l}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,a=new Array(r);t<r;t++)a[t]=e[t];return a}importScripts("lodash.js"),importScripts("tinycolor.js"),importScripts("moment.js"),importScripts("row.crossJoin.js");var calculateMap={">":function(e,r){return r>(e=""==e?Number.NEGATIVE_INFINITY:Number(e)||0)},">=":function(e,r){return r>=(e=""==e?Number.NEGATIVE_INFINITY:Number(e)||0)},"=":function(e,r){return r==(e=""==e?Number.NEGATIVE_INFINITY:Number(e)||0)},"<":function(e,r){return r<(e=""==e?Number.POSITIVE_INFINITY:Number(e)||0)},"<=":function(e,r){return r<=(e=""==e?Number.POSITIVE_INFINITY:Number(e)||0)}},DEBUG=!1,cache={},timeLog=function(e){return cache[e]=Date.now()},timeLogEnd=function(e){DEBUG&&postMessage({isProgressEvent:!0,progress:{stepName:e,time:Date.now()-cache[e]}}),delete cache[e]},strayMethods={sortUniqueLevelMember:function(e){return e.sort((function(e,r){return(e.properties.raw||e.value)-(r.properties.raw||r.value)}))},getProperMinMax:function(e,r,t,a,n){if(Math.abs(e)==1/0||Math.abs(r)==1/0)return{};if(a)return{start:e<0?-100:0,end:100,min:e<0?-100:0,max:100,interval:{1:100,2:50,3:25,4:25,5:20,6:20}[t||5]||20};e==r&&(r=e+Math.abs(.2*e));for(var o=function(e){for(var r=e.toString(),t=0,a=r.length-1;a>=0&&("0"==r[a]||"5"==r[a]);a--)t++;return t||.1},i=function(e){var r;return Number((null===(r=e.toString().split(".")[1])||void 0===r?void 0:r.length)||0)},l=function(e,r){return Number(e.toFixed(r))},u=function(e){for(var r=12,t=e/Math.pow(10,r);t<1;)r--,t=e/Math.pow(10,r);return Math.pow(10,r)},s=(n=n||e<0)?e:0,d=r||0,c=t||5,f=(d-s)/c,p=Number("100,000,000,000".replace(/,/g,"")),m=Math.floor(f/p);0!=f&&0==m;)p/=10,m=Math.floor(f/p);p=Number(p*m).toFixed(5);var v=function(e,r,t,a){var s=function(e){for(var r=i(e)+2,t=l(.5*e,r),a=u(.01*e),n=[],o=e-t;o<=e+t;o=l(o+a,r))String(o).match(/[0|5]$/g)&&n.push(o);return n}(a).map((function(e){return{unit:e}})),d=s.map((function(t){var a,l,u=t.unit;t.dicimal=i(u);var s=function(t,a){for(var o=Math.floor(e/t)*t;o<=r;)o+=t;var i=Number(o.toFixed(a));for(o=Math.ceil(r/t)*t;o>e;)o-=t;var l=Number((n?o:0).toFixed(a));return{min:l,max:i,splitNum:Number(((i-l)/t).toFixed(0))}}(u,t.dicimal),d=s.min,c=s.max,f=s.splitNum;return t.min=d,t.splitNum=f,t.max=c,t.priority=(Math.abs(c-r)+Math.abs(d-e))/u+10/(o(d)+o(c))+((null===(a=String(c).split(".")[1])||void 0===a?void 0:a.length)||0)+((null===(l=String(d).split(".")[1])||void 0===l?void 0:l.length)||0),t}));return(d=d.filter((function(e){return e.splitNum<=t+2&&e.splitNum>=t-2}))).sort((function(e,r){return e.priority-r.priority})),d[0]||{}}(s,d,c,p=Number(p)),y=v.min,h=v.max,g=v.unit,b=v.dicimal;p=g;for(var M=[],x=y;x<=h;)M.push(x),x=Number((x+p).toFixed(b));return{start:e,end:r,min:y,max:h,interval:p,array:M}},getSequenceKeys:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"...";return(e||[]).map((function(e){return e[r||"uniqueName"]})).sort((function(e,r){return String(e).localeCompare(String(r))})).join(t)},getNoneOrderSequenceKeys:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"...";return(e||[]).map((function(e){return e[r||"uniqueName"]})).join(t)},getDataPointName:function(e,r){if(Number(r&&r.raw))return Number(r.raw);var t,a,n=(r||{}).value;return e&&r&&(t=r.properties.uniquename.replace(r.properties.hierarchy+".",""),a=strayMethods.getMoment(t,e).valueOf()),a||n},shiftGroupOuter:function(e){var r=function e(r,t){return r.isMeasureNode?(t&&t.push(r),r):Array.isArray(r.colModel)?r.colModel.map((function(r){return e(r,t)})):r};e.every((function(t,a){var n,o={};return t.isGroup||t.isGrand?(e.splice(a,1),t.isGrand?(r(t,n=[]),n=n.filter((function(e){return!!e}))):n=r(t).filter((function(e){return!!e})),n.every((function(r){return Array.isArray(r)?r.every((function(r){return e.push(_.extend(r,o)),!0})):e.push(_.extend(r,o)),!0})),!1):(Array.isArray(t.colModel)&&t.colModel.length&&strayMethods.shiftGroupOuter(t.colModel),!0)}))},tryMergeGroupCell:function(e){var r=function e(r,t){return r.isMeasureNode?(t&&t.push(r),r):Array.isArray(r.colModel)?r.colModel.map((function(r){return e(r,t)})):r};e.every((function(t,a){var n,o={};return t.isGroup||t.isGrand?(o=e[a],t.isGrand?(r(t,n=[]),n=n.filter((function(e){return!!e}))):n=r(t).filter((function(e){return!!e})),n.length&&(o.colModel=[],n.every((function(e){return Array.isArray(e)?e.every((function(e){return this.push(_.extend(e)),!0}),this):this.push(_.extend(e)),!0}),o.colModel)),!1):(Array.isArray(t.colModel)&&t.colModel.length&&strayMethods.tryMergeGroupCell(t.colModel),!0)}))},getNumericUnitItem:function(e,r){return _.find([{text:function(){return"N/A"},id:"none",quantization:["zh","zh_CN","zh-CN"],for:null,autoRange:function(){return["en","en_US","en-US"].indexOf(r||"zh_CN")>=0?[0,100]:[0,1e4]},expression:function(e){return e}},{text:"万",id:"wan",quantization:["zh","zh_CN","zh-CN"],for:["zh","zh_CN","zh-CN"],autoRange:[1e4,1e6],expression:function(e){return e/1e4}},{text:"百万",id:"baiwan",quantization:["zh","zh_CN","zh-CN"],for:["zh","zh_CN","zh-CN"],autoRange:[1e6,1e8],expression:function(e){return e/1e6}},{text:"亿",quantization:["zh","zh_CN","zh-CN"],for:["zh","zh_CN","zh-CN"],id:"yi",autoRange:[1e8,Number.POSITIVE_INFINITY],expression:function(e){return e/1e8}},{text:"K",id:"k",quantization:["en","en_US","en-US"],autoRange:[1e3,1e6],for:["en","en_US","en-US","zh","zh_CN","zh-CN"],expression:function(e){return e/1e3}},{text:"M",id:"m",quantization:["en","en_US","en-US"],autoRange:[1e6,1e9],for:["en","en_US","en-US","zh","zh_CN","zh-CN"],expression:function(e){return e/1e6}},{text:"B",id:"b",quantization:["en","en_US","en-US"],autoRange:[1e9,Number.POSITIVE_INFINITY],for:["en","en_US","en-US","zh","zh_CN","zh-CN"],expression:function(e){return e/1e9}}],{id:e})},getMoment:function(e,r){var t=String(r).replace(/^\[|\]$/g,"");return t=String(t||"").replace(/\]\.\[/g,"&").replace(/y/g,"Y").replace(/d/g,"D"),e.match(/q|Q/)?t&&t.replace(/[^qQ]/g,"").match(/Q$/)&&(t=t.replace(/(.*)Q/,"$1q")):t=String(t||"").replace(/(.*)q/,"$1Q"),e=String(e||"").replace(/^\[|\]$/g,"").replace(/\]\.\[/g,"&"),moment(e,t)},getConfigedDateFormatter:function(e,r){var t,a=JSON.parse(e),n=[],o=(t=null,["ROWS","COLUMNS"].every((function(e){try{e=a.queryModel.axes[e]}catch(r){e=null}return null==e||_.isEmpty(e)||Array.isArray(e.hierarchies)&&e.hierarchies.every((function(e){for(var a in e.levels)if(e.name+".["+a+"]"==r){t=e.levels[a];break}return!t})),!t})),t);return o&&o.extend_properties&&o.extend_properties.display_format&&(n=o.extend_properties.display_format),n},colorAnalysis:function(e,r,t,a){var n,o=e.type,i=null;return 0!=Object.keys(e).length&&e.customize?"continues"==o?e.continues&&0!=Object.keys(e.continues).length?(n=e.continues,r<t||r>a?i:(i=tinycolor.mix(n.min,n.max,100*(r-t)/(a-t))).toRgbString()):i:(n=e.rules,Array.isArray(n)&&0!=n.length&&(n=_.find(e.rules,(function(e){var t=e.start_value,a=e.end_value,n=Boolean(_.isFunction(calculateMap[e.start])&&calculateMap[e.start](t,r));return _.isFunction(calculateMap[e.end])&&(n=n&&calculateMap[e.end](a,r)),n})))?n.color:i):i},getExtroMeasuresMinMax:function(e,r){var t,a=new Array;return Array.isArray(e)&&0!=e.length&&r&&r.based?(t="[Measures].["+r.based.id+"]",e.forEach((function(e){var r=e.data.map((function(e){var r=e.value;return e.measures[0].hasOwnProperty(t)&&(r=Number(e.measures[0][t])||0),r}));a=a.concat(r)})),{min:Math.min.apply(null,a),max:Math.max.apply(null,a)}):null},getModelLeafNodeCaption:function(e,r,t,a){var n,o=a,i=strayMethods.isNumeric(r)?r:1;return 0==i||("_hidden_"==(n=t[e])?1==i&&(o=""):o=n||o),o},isNumeric:function(e){var r=Number(String(e)||"null");return!isNaN(r)&&_.isNumber(r)},localeNumeric:function(e,r){return strayMethods.isNumeric(e)?Number(e).toFixed(strayMethods.isNumeric(r)?r:0).toString().split(".").map((function(e,r){return 0===r?String(e).replace(/\B(?=(\d{3})+(?!\d))/g,","):e})).join("."):e}};self.strayMethods=strayMethods;var getConditionalColor=function(e){var r=e.configs,t=e.datasets,a=e.colorKey,n={},o=t.map((function(e){var r=e.id,t=e.measures,o=null==t?void 0:t.find((function(e){return e.uniqueName==a}));return n[r]=Number((null==o?void 0:o.value)||0),n[r]})),i=Math.min.apply(Math,_toConsumableArray(o)),l=Math.max.apply(Math,_toConsumableArray(o));t.forEach((function(e){e.mixed="".concat(e.id,":::").concat(strayMethods.colorAnalysis(r,n[e.id],i,l))})),self.postMessage(t)};function transposeRowHeaderHeader(e){var r,t=e[0].filter((function(e){return"ROW_HEADER_HEADER"===e.type})),a=t.pop(),n=null==a||null===(r=a.properties)||void 0===r?void 0:r.level,o=e[0].findIndex((function(e){var r;return(null===(r=e.properties)||void 0===r?void 0:r.level)===n})),i=[],l=[],u=[];timeLog("transposeRowHeaderHeader");var s=_toConsumableArray(e.slice(1).reduce((function(e,r){var t,a,n=null===(t=r[o])||void 0===t?void 0:t.properties,i=(null==n?void 0:n.uniquename)||(null==n?void 0:n.level);return e.find((function(e){return e[0]==i}))||e.push([i,null===(a=r[o])||void 0===a?void 0:a.value]),e}),[])).map((function(r){var t=_slicedToArray(r,2),a=t[0],n=t[1];return{dataIndex:a,key:a,title:n,children:e[0].filter((function(e){return"ROW_HEADER_HEADER"!==e.type})).map((function(e){var r,t,a,o,i=n+(null==e||null===(r=e.properties)||void 0===r?void 0:r.raw);return l.push(i),u.push(null==e||null===(t=e.properties)||void 0===t?void 0:t.raw),{dataIndex:i,key:i,title:null==e?void 0:e.value,align:"[Measures]"==(null==e||null===(a=e.properties)||void 0===a?void 0:a.hierarchy)&&String(null==e||null===(o=e.properties)||void 0===o?void 0:o.raw).match(/^\[Measures\]\.\[/)?"right":"center"}}))}}));s.unshift({dataIndex:n,key:n,title:null==a?void 0:a.value,children:t.map((function(e){var r,t,a;return i.push(null==e||null===(r=e.properties)||void 0===r?void 0:r.level),{dataIndex:null==e||null===(t=e.properties)||void 0===t?void 0:t.level,key:null==e||null===(a=e.properties)||void 0===a?void 0:a.level,title:null==e?void 0:e.value,align:"center"}}))});var d=e.slice(1).reduce((function(e,r){var t,a=strayMethods.getSequenceKeys(r.slice(0,o).map((function(e){return e.uniquename=e.properties.uniquename,e})),"uniquename","..."),n=e.find((function(e){return e.key==a})),i=null===(t=r[o])||void 0===t?void 0:t.value;return n||(n={key:a,data:r.slice(0,o).reduce((function(e,r,t){var a;return e[null==r||null===(a=r.properties)||void 0===a?void 0:a.level]=null==r?void 0:r.value,e}),{})},e.push(n)),n.data=r.slice(o+1).reduce((function(e,r,t){var a;return e["".concat(i).concat(u[t])]=(null==r||null===(a=r.properties)||void 0===a?void 0:a.raw)||(null==r?void 0:r.value),e}),n.data),e}),[]).map((function(e){return e.data}));return timeLogEnd("transposeRowHeaderHeader"),{columns:s,dataSource:d}}var tryExtractAssistFields=function(e){var r=e.data,t=e.colorsKey,a=void 0===t?[]:t,n=e.iconsKey,o=void 0===n?[]:n,i=e.tooltipsKey,l=void 0===i?[]:i,u=e.tableLike,s=e.crossed,d=r||{},c=d.cellset,f=void 0===c?[]:c,p=d.headNum,m=[],v=[],y=[],h=function(e,r){var t,a,n=null===(t=f.slice(0,p))||void 0===t?void 0:t.pop(),o=[],i=e.map((function(e){var r=e.uuid||e.id,t=n.findIndex((function(e){var t;return(null===(t=e.properties)||void 0===t?void 0:t.id)===r}));return o.push(t),{id:r,indx:t}})),l={};i.length&&f.slice(0,p).forEach((function(e,r){f[r]=e.filter((function(e,r){var t,a=o.indexOf(r);a>=0&&(l[null==e||null===(t=e.properties)||void 0===t?void 0:t.id]=null==e?void 0:e.value);return a<0}))})),i.length&&(null===(a=f.slice(p))||void 0===a||a.forEach((function(e,t){var a=e.filter((function(e){return"DATA_CELL"!=e.type})).map((function(e){var r;return null===(r=e.properties)||void 0===r?void 0:r.uniquename})),n={toLink:a};i.forEach((function(t){var o,i=t.id,u=t.indx,s=e[u];n[i]={raw:Number((null==s||null===(o=s.properties)||void 0===o?void 0:o.raw)||(null==s?void 0:s.value))||null,value:null==s?void 0:s.value,caption:l[i]},r.find((function(e){return e.toLink.join(":::")==a.join(":::")}))||r.push(n)})),f[p+t]=e.filter((function(e,r){return o.indexOf(r)<0}))})))},g=r.uniqueLevels||{};for(var b in g)Array.isArray(g[b])&&strayMethods.sortUniqueLevelMember(g[b]);if(p>1||u||!f||(null==f?void 0:f.length)<1)return self.postMessage(r),r;if(null!=s&&s.length&&null!=f&&f.length){var M=transposeRowHeaderHeader(f);r.formatAsPivot=M}else{var x,N,S=null==f||null===(x=f.slice(0,1)[0])||void 0===x?void 0:x.reduce((function(e,r){var t,a,n,o=(null==r||null===(t=r.properties)||void 0===t?void 0:t.raw)||(null==r||null===(a=r.properties)||void 0===a?void 0:a.uniquename);return e.push({dataIndex:o,key:o,title:null==r?void 0:r.value,align:"[Measures]"==(null==r||null===(n=r.properties)||void 0===n?void 0:n.hierarchy)&&o.match(/^\[Measures\]\.\[/)?"right":"center"}),e}),[]),_=null==f||null===(N=f.slice(1))||void 0===N?void 0:N.map((function(e){return e.reduce((function(e,r,t){var a,n,o=null===(a=S[t])||void 0===a?void 0:a.key;o.match(/^\[Measures\]\.\[/)?e[o]=(null==r||null===(n=r.properties)||void 0===n?void 0:n.raw)||(null==r?void 0:r.value):e[o]=null==r?void 0:r.value;return e}),{})}),[]);r.formatAsPivot={columns:S,dataSource:_}}Array.isArray(a)&&h(a,m),Array.isArray(l)&&h(l,y),Array.isArray(o)&&h(o,v),r.colorArray=m,r.tooltipArray=y,r.iconArray=v,self.postMessage(r)},componentsUtils={HyQuerySelectorComponent:function(e,r,t){return componentsUtils.BootstrapListsComponent(e,r,t)},BootstrapButtonsComponent:function(e,r,t){return componentsUtils.BootstrapListsComponent(e,r,t)},DropdownSelectComponent:function(e,r,t){return componentsUtils.BootstrapListsComponent(e,r,t)},RadioButtonsComponent:function(e,r,t){return componentsUtils.BootstrapListsComponent(e,r,t)},BootstrapListsComponent:function(e,r,t){var a=r.map((function(e){var r=e.datafor_rows[0];return{id:r.uniqueName||r.uniquename,name:r.levelCaption,text:e[r.level]||r.value}}));return{list:a,copy:JSON.parse(JSON.stringify(a))}},EchartsBaseHorizontalBarchart:function(){return componentsUtils.EchartsBaseBarchart.apply(componentsUtils,Array.prototype.slice.call(arguments,0))},EchartsBaseBarchart:function(){var e=componentsUtils.EchartsBaseLinechart.apply(componentsUtils,Array.prototype.slice.call(arguments,0));return e.series.forEach((function(e){Array.isArray(e.data)&&e.data.forEach((function(e){e.value=Array.isArray(e.fullValue)?e.fullValue[e.fullValue.length-1]:e.value}))})),e},EchartsRatioStackAreachart:function(){var e=componentsUtils.EchartsBaseLinechart.apply(componentsUtils,Array.prototype.slice.call(arguments,0)),r=e.x.data||[],t=[];return e.series.forEach((function(e){var a=e.name;e.stack="stack",e.type="line",e.symbolSize=1,e.labelLayout=Object.assign(e.labelLayout||{},{hideOverlap:!0}),e.connectNulls=!0,e.data.forEach((function(e,t){var n,o=r[t];if(Array.isArray(e.fullValue)&&e.fullValue.length>1){if(n=Number(100*e.fullValue[1]/o.totalAbs).toFixed(1),e.fullValue[1]=Number(n),e.tip&&e.tip.cross&&Array.isArray(e.tip.cross.rows))(i=_.find(e.tip.cross.rows,{caption:a}))&&(i.value=n+"%("+i.value+")");else if(e.tip&&Array.isArray(e.tip.rows)){var i;(i=_.find(e.tip.rows,{caption:a}))&&(i.value=n+"%("+i.value+")")}e.vtip=n+"%"}else e.fullValue=Array.isArray(e.fullValue)?[e.fullValue]:[],e.fullValue[0]=Number(o.raw)||o.value,e.fullValue[1]=0,e.vtip=null})),e.lineStyle={normal:{opacity:1}},e.areaStyle={normal:{opacity:.5}},t.push(a)})),e.legend=t,e.formats.y=["#,##0.0%"],e},EchartsBaseDotschart:function(e,r,t,a,n,o,i){var l,u=[],s=JSON.parse(n.query),d=rCrossJoin.getPrimaryFields(e,s,"legend.fields"),c=rCrossJoin.getCrossField(e,s,"legend.fields"),f=rCrossJoin.getQueryMesures(e,!0),p=rCrossJoin.getQueryMesures(e),m=d[d.length-1]||{},v=i.members||{},y=[],h=[],g=[],b=f.map((function(e){return e.key}));if(c){var M=c.key,x=(v[M]||[]).reduce((function(e,r){return e[r.value]={type:"scatter",lineStyle:{},data:[],itemStyle:{},label:{},id:r.properties.uniquename,labelLayout:{},measureGroup:b,name:r.value},e}),{});for(var N in r.forEach((function(e){var r,t,a=rCrossJoin.getSystemCalculatedMeasuresValue(p,e),n=e[M],o=x[n];o&&(t={id:(r=_.find(e.datafor_rows,{level:m.key})||{}).uniquename,name:r.value,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,p,a),value:b.reduce((function(r,t){var a=(e[t]||{}).raw,n=void 0!==a?Number(a):null;return r.push(n),r}),[])},o.data.push(t),3===t.value.length&&y.push(t.value[2]),t.value.length>0&&h.push(t.value[0]),t.value.length>1&&g.push(t.value[1]),t.tip=e.tip,t.color=e.color)})),x)u.push(x[N])}else{var S={type:"scatter",id:m.key,name:m.value,measureGroup:b,data:[]};u.push(S),r.forEach((function(e,r){var t=rCrossJoin.getSystemCalculatedMeasuresValue(p,e),a=e[S.measureGroup]||{},n=_.find(e.datafor_rows,{level:m.key})||{},o={name:n.value,formatted:a.formatted,id:n.uniqueName,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,p,t)};o.value=b.reduce((function(r,t){var a=(e[t]||{}).raw,n=void 0!==a?Number(a):null;return r.push(n),r}),[]),3===o.value.length&&y.push(o.value[2]),o.value.length>0&&h.push(o.value[0]),o.value.length>1&&g.push(o.value[1]),o.color=e.color,o.tip=e.tip,S.data.push(o)}))}l={data:u.reduce((function(e,r){return e.push({name:r.name}),e}),[])};t.filter((function(e){return e.isMeasureNode})).map((function(e){return e.format}));return{series:u,legend:l,radiusMin:Math.min.apply(null,y),radiusMax:Math.max.apply(null,y),xMin:Math.min.apply(null,h),xMax:Math.max.apply(null,h),yMin:Math.min.apply(null,g),yMax:Math.max.apply(null,g),radiusMeasure:3===p.length?p[2].title:null,seriesLevel:c?c.title:null,primary:m?m.title:null}},EchartsRadarchart:function(e,r,t,a,n,o,i){var l,u,s={series:[],radar:{indicator:[]},legend:{}},d=JSON.parse(n.query),c=rCrossJoin.getPrimaryFields(e,d,"legend.fields"),f=rCrossJoin.getCrossField(e,d,"legend.fields"),p=rCrossJoin.getQueryMesures(e,!0),m=(f||{}).key,v=c[c.length-1]||{},y=i.members||{},h=y[v.key]||[],g=y[m]||[],b=null===(l=p[0])||void 0===l?void 0:l.key,M=[];s.series=[],s.radar.indicator=h.map((function(e){return{name:e.value,id:e.properties.uniquename,level:e.properties.level}})),null!==(u=g)&&void 0!==u&&u.length?g.forEach((function(e){e.mKey=b})):g=e.filter((function(e){return e.isMeasureNode})).map((function(e){return{value:e.title,properties:{level:null},mKey:e.key}})),g.forEach((function(e){var t=e.properties.level,a=e.value,n={data:[],name:a,type:"radar",symbol:"circle",symbolSize:8,animationType:"expansion",z:1},o=e.mKey;s.series.push(n),s.radar.indicator.forEach((function(e){var i,l=e.level,u=e.name,s=_.find(r,(function(e){return(!t||e[t]==a)&&e[l]==u}));s?(i=s[o]||{},n.data.push(void 0!==i.raw?Number(i.raw):null),n.props={color:s.color}):n.data.push(null)})),M.push.apply(M,_toConsumableArray(n.data.filter((function(e){return null!==e})))),n.data=[n.data];var i={normal:{color:"transparent"}};s.radar.indicator.forEach((function(e,l){var u=e.level,d=e.name,c={data:[n.data[0].map((function(e,r){return r==l?e:null}))],groupName:a,seriesId:o,name:d,type:"radar",z:2,animationType:"expansion",symbol:"none",symbolSize:8,props:{},itemStyle:_objectSpread({},i),lineStyle:_objectSpread({},i),areaStyle:_objectSpread({},i)},f=_.find(r,(function(e){return(!t||e[t]==a)&&e[u]==d}));f&&(c.props.tip=f.tip,c.props.color=f.color),s.series.push(c)}))}));var x=Math.min.apply(null,M),N=Math.max.apply(null,M),S=strayMethods.getProperMinMax(x||0,N||0,4),A=S.min,w=S.max;return s.radar.indicator.forEach((function(e){e.min=A,e.max=w})),s.legend={data:[]},s},EchartsBaseMulPiechart:function(e,r,t,a,n,o,i){var l={type:"pie",lineStyle:{},data:[],itemStyle:{},label:{},labelLayout:{}},u=[],s=JSON.parse(n.query),d=rCrossJoin.getPrimaryFields(e,s,"legend.fields"),c=rCrossJoin.getCrossField(e,s,"legend.fields"),f=rCrossJoin.getQueryMesures(e,!0),p=rCrossJoin.getQueryMesures(e),m=[],v=d[d.length-1]||{},y=i.members||{},h=i.levelMetas||{},g=y[v.key]||[],b=String((h[v.key]||{}).dateFormat),M=(h[v.key]||{}).levelType,x=M;if(M="QUANTITATIVE"==M?"value":"REPRESENTATIVE"==M?"category":b?"time":"category",m=g.reduce((function(e,r){return e.push({id:r.properties.uniquename,value:r.value,total:0}),e}),[]),f.length>1||d.length<1&&!c)r.forEach((function(e){var r=rCrossJoin.getSystemCalculatedMeasuresValue(p,e),t=_.find(e.datafor_rows,{level:v.key})||{};f.forEach((function(a,n){var o=a.key,i=_.find(u,{id:o});i||(i=_.extend({},l,{id:o,name:a.title,data:[]}),u.push(i));var s=e[o]||{},d={name:t.value,value:void 0!==s.raw?Number(s.raw):void 0,formatted:s.formatted,id:t.uniqueName,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,p,r)};d.tip=e.tip,d.color=e.color,i.data.push(d);var c=_.find(m,{id:d.id});c&&(c.total+=d.value||0)}))}));else if(f=f[0]||{},c){var N=y[c.key]||[],S=f.key||f.uniqueName;m=N.reduce((function(e,r){return e.push({id:r.properties.uniquename,value:r.value,total:0}),e}),[]),u=g.reduce((function(e,t){var a=t.properties.level,n={type:"pie",id:t.properties.uniquename,name:t.value,measureGroup:S,measureName:f.title},o=n.name;return e.push(n),n.data=N.reduce((function(e,t,n){var i,l,u=t.properties.level,s=t.properties.uniquename,d=t.value,c=_.find(r,(function(e){return e[a]==o&&e[u]==d})),f={};if(c){var v=rCrossJoin.getSystemCalculatedMeasuresValue(p,c);l=void 0!==(f=c[S]||{}).raw?Number(f.raw):f.raw,(i={name:d,id:s,levels:c.datafor_rows,measures:rCrossJoin.tryPackageMesures(c,p,v),formatted:f.formatted,vtip:f.hasOwnProperty("vtip")?f.vtip:f.formatted,fullValue:l,value:l}).tip=c.tip,i.color=c.color}else i={name:d,id:s,formatted:""};return e.push(i),(m[n]||{}).total+=l||0,e}),[]),e}),[])}else{var A=_.extend({},l,{id:f.key,name:f.title,measureGroup:f.key,measureName:f.title,data:[]});u.push(A),r.forEach((function(e,r){var t=rCrossJoin.getSystemCalculatedMeasuresValue(p,e),a=e[A.measureGroup]||{},n=void 0!==a.raw?Number(a.raw):void 0,o=_.find(e.datafor_rows,{level:v.key})||{},i={name:o.value,fullValue:n,value:n,formatted:a.formatted,id:o.uniqueName,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,p,t)};i.tip=e.tip,i.color=e.color,(m[r]||{total:0}).total+=Number(a.raw)||0,A.data.push(i)}))}var w={data:u.length?u[0].data.reduce((function(e,r){return e.push(r.name),e}),[]):[]};return{series:u,legend:w,x:{data:m,d_fieldType:M,timeType:x},seriesLevel:c?c.title:null,primary:v?v.title:null}},EchartsBaseLineBarchart:function(e,r,t,a,n,o,i){var l=componentsUtils.EchartsBaseLinechart.apply(componentsUtils,Array.prototype.slice.call(arguments,0)),u=n.extros,s=u.lines,d=void 0===s?[]:s,c=(u.bars,0),f="",p=l.x.data||[];l.x.data=r.map((function(e,r){var t=e.datafor_rows,a=void 0===t?[]:t,n=(a[a.length-1]||{}).value;return String(n).length>c&&(c=String(n).length,f=n),{raw:p[r].raw,value:n}}));var m=[],v=[],y=function(e){return null!=e&&""!==e};return timeLog("linebarchart tip"),l.series.forEach((function(e){var r,a,n,o;(e.labelLayout=Object.assign(e.labelLayout||{},{hideOverlap:!0}),null===(r=e.data)||void 0===r||r.forEach((function(e){var r,t,a;null===(r=e.tip)||void 0===r||null===(r=r.rows)||void 0===r||r.forEach((function(e){return delete e.only})),void 0===(null===(t=e.fullValue)||void 0===t?void 0:t[0])&&void 0!==(null===(a=e.fullValue)||void 0===a?void 0:a[1])&&(e.value=e.fullValue[1])})),e.dataforFormat=null===(a=t.find((function(r){return String(e.id).match(/^\[Measures\].\[/g)?r.uniqueName==e.id:r.key==e.id})))||void 0===a?void 0:a.format,d.includes(e.id))?(e.type="line",m.push.apply(m,_toConsumableArray((null===(n=e.data)||void 0===n?void 0:n.map((function(e){var r=e.value;return Array.isArray(r)?_toConsumableArray(r).pop():r})).filter(y))||[]))):(e.type="bar",v.push.apply(v,_toConsumableArray((null===(o=e.data)||void 0===o?void 0:o.map((function(e){var r=e.value;return Array.isArray(r)?_toConsumableArray(r).pop():r})).filter(y))||[])))})),timeLogEnd("linebarchart tip"),l.y.lines={axisMin:Math.min.apply(Math,m),axisMax:Math.max.apply(Math,m)},l.y.bars={axisMin:Math.min.apply(Math,v),axisMax:Math.max.apply(Math,v)},delete l.formats,l.x.axisMaxLabel=f,l},EchartsStackAreachart:function(){return componentsUtils.EchartsBaseLinechart.apply(componentsUtils,Array.prototype.slice.call(arguments,0))},EchartsBaseAreachart:function(){return componentsUtils.EchartsBaseLinechart.apply(componentsUtils,Array.prototype.slice.call(arguments,0))},EchartsBaseLinechart:function(e,r,t,a,n,o,i){var l,u={type:"line",lineStyle:{},symbolSize:1,data:[],itemStyle:{},label:{},labelLayout:{}},s=[],d=JSON.parse(n.query),c=rCrossJoin.getPrimaryFields(e,d,"legend.fields"),f=rCrossJoin.getCrossField(e,d,"legend.fields"),p=rCrossJoin.getQueryMesures(e,!0),m=rCrossJoin.getQueryMesures(e),v=[],y=c[c.length-1]||{},h=i.members||{},g=i.levelMetas||{},b=h[y.key]||[],M=(g[y.key]||{}).dateFormat,x=(g[y.key]||{}).levelType,N=x;if(M=M?String(M):null,x="QUANTITATIVE"==x?"value":"REPRESENTATIVE"==x?"category":M?"time":"category",timeLog("linechart base init"),v=b.reduce((function(e,r){return e.push({id:r.properties.uniquename,raw:r.properties.raw,value:r.value,total:0,totalAbs:0}),e}),[]),timeLogEnd("linechart base init"),p.length>1||c.length<1&&!f){var S=!f&&c.length<1;timeLog("linechart measures"),r.forEach((function(e,r){var t=rCrossJoin.getSystemCalculatedMeasuresValue(m,e),a=_.find(e.datafor_rows,{level:y.key})||{};p.forEach((function(n,o){var i=n.key,l=_.find(s,{id:i});l||(l=_.extend({},u,{id:i,name:n.title,data:[]}),s.push(l));var d=e[i]||{},c={name:(null==a?void 0:a.value)||n.title,value:void 0!==d.raw?Number(d.raw):void 0,formatted:d.formatted,id:(null==a?void 0:a.uniqueName)||i,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,m,t)},f=strayMethods.getDataPointName(M,b[S?o:r]);c.fullValue=[f,c.value],c.tip=e.tip||{},c.color=e.color,l.data.push(c);var p=_.find(v,{id:c.id});p&&(p.total+=c.value||0,p.totalAbs+=Math.abs(c.value||0))}))})),timeLogEnd("linechart measures")}else if(p=p[0]||{},f){var A=f.key,w=h[A]||[],C=p.key||p.uniqueName,L=strayMethods.getSequenceKeys;timeLog("linechart crossjoin");var E={},O=[y.key,A];r.forEach((function(e){return E[L(e.datafor_rows.filter((function(e){return O.includes(e.level)})),"uniqueName","...")]=e})),s=w.reduce((function(e,r){r.properties.level;var t=r.properties.uniquename,a={id:t,name:r.value,measureGroup:C,measureName:p.title};return e.push(a),a.data=b.reduce((function(e,r,a){var n,o,i,l=r.properties.uniquename,u=r.value,s=L([{uniqueName:t},{uniqueName:l}],"uniqueName","..."),d=E[s],c={};if(d){var f=rCrossJoin.getSystemCalculatedMeasuresValue(m,d);o=strayMethods.getDataPointName(M,r),i=void 0!==(c=d[C]||{}).raw?Number(c.raw):c.raw,n={name:u,id:l,levels:d.datafor_rows,measures:rCrossJoin.tryPackageMesures(d,m,f),formatted:c.formatted,vtip:c.hasOwnProperty("vtip")?c.vtip:c.formatted,fullValue:[o,i],value:[o,i]}}else n={name:u,id:l,formatted:"",fullValue:[],value:void 0};n.color=null==d?void 0:d.color,n.tip=(null==d?void 0:d.tip)||{},e.push(n);var p=v[a]||{total:0,totalAbs:0};return p.total+=i||0,p.totalAbs+=Math.abs(i||0),e}),[]),e}),[]),timeLogEnd("linechart crossjoin")}else{var k=_.extend({},u,{id:p.key,name:p.title,measureGroup:p.key,measureName:p.title,data:[]});timeLog("linechart default"),s.push(k),r.forEach((function(e,r){var t=rCrossJoin.getSystemCalculatedMeasuresValue(m,e),a=e[k.measureGroup]||{},n=void 0!==a.raw?Number(a.raw):void 0,o=_.find(e.datafor_rows,{level:y.key})||{},i=strayMethods.getDataPointName(M,b[r]),l={name:o.value,fullValue:[i,n],value:[i,n],formatted:a.formatted,vtip:a.hasOwnProperty("vtip")?a.vtip:a.formatted,id:o.uniqueName,levels:e.datafor_rows,measures:rCrossJoin.tryPackageMesures(e,m,t)},u=v[r]||{total:0,totalAbs:0};u.total+=Number(a.raw)||0,u.totalAbs+=Math.abs(Number(a.raw)||0),l.color=e.color,l.tip=e.tip||{},k.data.push(l)})),timeLogEnd("linechart default")}var z="",I=Number.POSITIVE_INFINITY,q=Number.NEGATIVE_INFINITY;if(timeLog("linechart axis extrim"),v.length?v.forEach((function(e){var r=e.value,t=e.total;I=Math.min(I,t||0),q=Math.max(q,t||0),z.length<String(r).length&&(z=r)})):s.forEach((function(e){var r=e.name;r.length>z.length&&(z=r)})),null!==(l=n.extros)&&void 0!==l&&l.isStackSumMode&&v.length);else{var T=[];s.forEach((function(e){e.data.forEach((function(e){var r=e.value,t=Array.isArray(r)?_toConsumableArray(r).pop():r;null!=t&&T.push(t)}))})),I=Math.min.apply(null,T),q=Math.max.apply(null,T)}var P={};if("REPRESENTATIVE"!=N){var j=v.map((function(e){return parseFloat(e.value||0)}));P.axisMin=Math.min.apply(Math,_toConsumableArray(j)),P.axisMax=Math.max.apply(Math,_toConsumableArray(j))}timeLogEnd("linechart axis extrim");var J=t.filter((function(e){return e.isMeasureNode})).map((function(e){return e.format}));return{series:s,formats:{y:J},y:{axisMin:I,axisMax:q},x:_objectSpread({axisMaxLabel:z,data:v,d_fieldType:x,timeType:N},P),seriesLevel:f?f.title:null,primary:y?y.title:null}},EchartsBaseTreeMapchart:function(e,r,t,a,n){var o,i=function(e,r){return e.map((function(e){return e[r]})).join("~")},l=JSON.parse(n.query),u=rCrossJoin.getQueryMesures(e),s=new Array,d=e.filter((function(e){return"true"==String(e.isMeasureNode)})),c=rCrossJoin.getCrossField(e,l,"legend.fields"),f=null===(o=_.find(d,(function(e){return!String(e.caption).match(/^UUID\-/)})))||void 0===o?void 0:o.key;e.filter((function(e){return"false"==String(e.isMeasureNode)})).length<2?r.forEach((function(e){var r=rCrossJoin.getSystemCalculatedMeasuresValue(u,e),t=e.datafor_rows,a=t.slice(-1),n=i(t,"uniqueName"),o=_.find(s,{id:n}),l=e[f]||{};o||(o={id:n,name:a[0].value,value:Number(l.raw),formatted:l.formatted,vtip:l.hasOwnProperty("vtip")?l.vtip:l.formatted,levels:t,tip:e.tip,color:e.color,measures:rCrossJoin.tryPackageMesures(e,u,r)}),s.push(o)})):r.forEach((function(e){var r=rCrossJoin.getSystemCalculatedMeasuresValue(u,e),t=e.datafor_rows,a=t.slice(0,t.length-1),n=t.slice(-1),o=i(a,"uniqueName"),l=_.find(s,{id:o}),d=e[f];l||(l={id:o,formatted:"",value:"",name:i(a,"value"),children:[]},s.push(l)),l.children.push({id:i(t,"uniqueName"),name:n[0].value,value:Number(d.raw),formatted:d.formatted,tip:e.tip,color:e.color,vtip:d.hasOwnProperty("vtip")?d.vtip:d.formatted,levels:t,measures:rCrossJoin.tryPackageMesures(e,u,r)}),l.value=l.children.reduce((function(e,r){return e+(r.value||0)}),0)})),1===s.length&&Array.isArray(s[0].children)&&s[0].children.length>0&&(s=s[0].children);var p={type:"treemap",left:10,right:10,top:10,bottom:20,upperLabel:{show:!0,padding:0,position:"insideLeft",fontSize:12,height:16,crossed:!!c},levels:[{upperLabel:{show:!1},itemStyle:{borderWidth:0,borderColor:"#fff",gapWidth:c?0:1}},{itemStyle:{borderColor:"#fff",borderWidth:c?2:0,gapWidth:0}}],visibleMin:0,childrenVisibleMin:0,data:s,roam:!1,nodeClick:!1,breadcrumb:{show:!1},itemStyle:{}};return c?[_objectSpread(_objectSpread({},p),{},{itemStyle:{gapWidth:3,borderColor:"#fff",borderWidth:.5},data:p.data.map((function(e){return Object.assign({},e,{upperLabel:{show:!0}})}))}),_objectSpread(_objectSpread({},p),{},{type:"treemap",itemStyle:{opacity:1,gapWidth:3},label:{show:!0,position:"insideLeftTop",fontSize:22},nodeClick:!1,data:p.data.map((function(e){return{name:e.name,value:e.value,itemStyle:{borderWidth:1,borderColor:"#fff"}}})),z:0})]:[_objectSpread({},p)]},EchartsBaseSankeychart:function(e,r,t,a,n,o,i){var l,u={data:[],links:[]},s=u.data,d=u.links,c=function(e,r){var t=e.queryModel.details.measures.map((function(e){return e}));return r?t.filter((function(e){return"EXACT"==e.type}))[0]:t.filter((function(e){return!String(e.value||e.name).match(/^UUID\-/)}))[0]}(JSON.parse(n.query),!1)||{},f=t.filter((function(e){return!(1!=e.isMeasureNode||!e.datafor_columns.length||"true"==e.datafor_columns[0].istotal)||(Array.isArray(e.datafor_columns)&&e.datafor_columns[0]&&"true"==e.datafor_columns[0].istotal&&(l=e.key),!1)})).map((function(e){var r=e.datafor_columns[0];return _.extend({uuid:r.uniquename,name:r.uniquename,levels:[r],measures:[],title:r.value,value:null,label:{position:"left"},formatted:"",dataIndex:e.key,target:!0})}));return r.forEach((function(e){var r=e.datafor_rows,t=r[r.length-1],a=e[l]||{},n={uuid:t.uniquename,name:t.uniquename,title:t.value,value:a.raw,formatted:a.formatted,vtip:a.hasOwnProperty("vtip")?a.vtip:a.formatted,levels:r,measures:[],source:!0},o=n.name,i=n.title,u=c.id||c.uniqueName;"true"==t.issum||("true"==t.istotal?f.forEach((function(r){var t=e[r.uuid+"~"+u]||{};r.value=t.raw,r.formatted=t.formatted,r.vtip=t.vtip||t.formatted})):(s.push(n),f.forEach((function(t){var a=e[t.uuid+"~"+u]||{},n=Number(a.raw)||0,l=t.uuid;d.find((function(e){var r=e.source,t=e.target;return r==o&&t==l}))||d.push({source:o,target:l,sName:i,levels:r.concat(t.levels),measures:[],tName:t.title,value:n,formatted:a.formatted,vtip:a.hasOwnProperty("vtip")?a.vtip:a.formatted})}))))})),f.forEach((function(e){s.push(e)})),u},EchartsBasePiechart:function(e,r,t){var a={name:"___",type:"pie",label:{normal:{position:"inside"}},animationType:"expansion",labelLine:{normal:{show:!1}},center:["50%","50%"],avoidLabelOverlap:!0,data:[],stillShowZeroSum:!1},n={};return e.forEach((function(e,r){var t=e.dataIndex,a=Array.isArray(e.datafor_properties)&&e.datafor_properties[e.datafor_properties.length-1]||{};n[t]=_.extend({caption:e.title,uniqueName:a.uniquename},a)})),r.forEach((function(e,r){var t,a,o=e.datafor_rows[e.datafor_rows.length-1],i={};for(var r in Object.keys(e).forEach((function(r){String(r).match(/^\[Measures\]\.\[UUID\-/)&&(i[r]=e[r].raw,delete e[r])})),e)if(!(Array.isArray(e[r])||!_.isObject(e[r])||Object.keys(e[r]).length<2)){var l;if(t=e[r],a={cateID:o?o.uniquename+"~"+r:r,formatted:t.formatted,vtip:t.hasOwnProperty("vtip")?t.vtip:t.formatted,value:Number(t.raw)||0,levels:e.datafor_rows.filter((function(e){return!!e})).map((function(r){var t=r.level,a=n[t]||{};return r.uniqueName=r.uniquename,delete r.uniquename,_.extend({levelCaption:a.caption,caption:e[t]},r)})),name:o?e[o.level]:(n[r]||{}).caption,measures:n[r]?[_.extend({value:Number(t.raw)||0,formatted:t.formatted,vtip:t.hasOwnProperty("vtip")?t.vtip:t.formatted},n[r],i)]:[]},o)a.tip=e.tip;else a.tip={rows:null===(l=e.tip)||void 0===l||null===(l=l.rows)||void 0===l?void 0:l.filter((function(e){return!e.only||e.only==a.cateID})).map((function(e){return{caption:e.caption,value:e.value}}))};a.color=e.color,this.push(a)}}),a.data),0===a.data.filter((function(e){return e&&0!==Number(e.value)})).length&&(a.isAllZero=!0),a},EchartsBaseCalendarChart:function(e,r,t,a,n){var o,i=n.dateAnalyzerFormats||[],l={calendar:[],series:[]},u={},s=_.find(e,{isMeasureNode:!1}),d=_.find(e,{isMeasureNode:!0});for(var c in i=(_.find(i,{uniqueName:s.key})||{}).format||"",r.filter((function(e){var r=e.datafor_rows[0];return moment(Number(null==r?void 0:r.raw)).isValid()})).forEach((function(e){var r,t=e.datafor_rows[0],a=String(t.uniqueName).replace(t.hierarchy+".",""),n=moment(Number(t.raw)),o=e[d.key],l=n.isValid()?n.format("YYYY-MM-DD"):moment(null==t?void 0:t.value).format("YYYY-MM-DD"),s=(o.raw,o.formatted);if(moment.isMoment(n)||(n=strayMethods.getMoment(a,i)),moment.isMoment(n)){s={name:l,value:[l,Number(o.raw)||"-"],formatted:o.formatted,levels:e.datafor_rows,measures:[_.extend(d,{value:o.raw,formatted:o.formatted})],tip:e.tip,color:e.color};try{(r=n.isValid()?n.year():moment(null==t?void 0:t.value).year())in u?u[r].push(s):u[r]=[s]}catch(e){console.log(e.stack)}}})),o=90/Object.keys(u).length,u)l.series.push({calendarIndex:l.calendar.length,coordinateSystem:"calendar",type:"heatmap",data:u[c]}),l.calendar.push({top:10+l.calendar.length*o+"%",height:o-8+"%",cellSize:["auto","auto"],range:c,yearLabel:{margin:20},dayLabel:{nameMap:["zh-CN","zh","zh_CN"].indexOf(n.locale)>0?"cn":"en"},monthLabel:{nameMap:["zh-CN","zh","zh_CN"].indexOf(n.locale)>0?"cn":"en"}});return l},EchartsBaseFunnelchart:function(e,r,t,a,n){n={categoryID:"",cateID:"",type:"funnel",top:32,left:50,min:Number.POSITIVE_INFINITY,right:10,bottom:10,minSize:3,maxSize:"60%",sort:"descending",name:"_",label:{normal:{show:!0,position:"left"},emphasis:{show:!0}},data:new Array};var o=_.find(e,["isMeasureNode",!1]);return o?(n.categoryID=o.key,n.data=r.map((function(r){var t=_.find(e,"isMeasureNode")||{},a=r[o.key],n=r[t.key]||{};return{name:a,id:_.find(r.datafor_rows||[],["value",a]).uniqueName,value:n.raw,formatted:n.formatted,vtip:n.hasOwnProperty("vtip")?n.vtip:n.formatted,levels:r.datafor_rows.map((function(e){return e})),measures:[_.extend({value:n.raw,formatted:n.formatted,vtip:n.hasOwnProperty("vtip")?n.vtip:n.formatted},t)]}}))):(n.categoryID=_.map(e,"key").join("~"),n.data=_.filter(e,"isMeasureNode").map((function(r){var t=r.key,a=this[t]||{};return{name:r.title,id:t,value:a.raw,formatted:a.formatted,vtip:a.hasOwnProperty("vtip")?a.vtip:a.formatted,levels:[],measures:e.map((function(e){var r=this[e.key];return _.extend({value:r.raw,formatted:r.formatted,vtip:r.hasOwnProperty("vtip")?r.vtip:r.formatted},e)}),this)}}),r[0]||{})),n.cateID=n.categoryID,n.max=Math.max.apply(null,_.map(n.data||[],"value")),n.min=Math.min.apply(null,_.map(n.data||[],"value")),(n.data||[]).sort((function(e,r){return e.value-r.value})).forEach((function(e,r){var t;t=this[r+1]?this[r+1].value:this[r].value,e.convert=(100*(e.value||0)/(t||1)).toFixed(2)+"%",e.arrival=(100*(e.value||0)/(n.max||1)).toFixed(2)+"%"}),n.data||[]),[n]},ParamQueryTableBasic:function(e,r,t,a,n,o){var i=Array.prototype.slice.call(arguments,0);return componentsUtils.ParamQueryLoadingPivot.apply(null,i)},ParamQueryListTree:function(e,r,t,a,n){var o,i,l=Array.prototype.slice.call(arguments,0),u=componentsUtils.ParamQueryLoadingPivot.apply(null,l),s=n.toParseWorker||{},d=s.treeGroupName,c=function e(r){return r&&Array.isArray(r.colModel)&&0!==r.colModel.length?e(r.colModel[0]):r};strayMethods.shiftGroupOuter(u.colModel),o=function(e){var r,t=_.find(u.colModel,{isColumnDimensionNode:!0,isColumnNameNode:!0});return t||(t=_.find(u.colModel,{isMeasureNode:!1})),{column:t,key:(r=c(t))?r.key:null}}(u.colModel),(i=o.column)&&(delete i.colModel,i.dataIndx="datafor_tree_name",i.key="datafor_tree_name",i.title=d,i.titleOrigin=d,i.isTreeColumnNode=!0),function e(r,t){(r||[]).filter((function(e){return"empty_column_scroll"!=e.dataIndx})).forEach((function(r,a){r.isMeasureNode?r.hidden=!1:(r.isColumnNameNode||t.isColumnNameNode||r.isGrand||r.isGroup||"numericIndex"===r.dataIndx?r.hidden=!1:r.hidden=!0,t.collapseModel=t.collapseModel||{on:r.hidden}),r&&Array.isArray(r.colModel)&&r.colModel.length&&e(r.colModel,r)}))}(u.colModel,{isColumnNameNode:!0});var f=[];Array.isArray(s.grouped)&&(u.colModel=u.colModel.filter((function(e,r){return s.grouped.indexOf(e.key)<0||(f.push(e.key),!1)})));var p=f.length+(i?1:0),m=s.grouped.map((function(e){return e})),v=function(e,r){var t=e.datafor_rows.filter((function(e){return e.level!==r&&"true"!=String(e.issum)}));return t=_.find(t,(function(e){return m.indexOf(e.level)>=0}))?t.map((function(e){return e.uniqueName})).join("~"):null};return u.dataModel.data.every((function(e,t){e.datafor_rows[0];if(e.datafor_tree_name=e[o.key],e.shouldNextLoad=!0,e.pq_close=!0,e.myuuid=e.datafor_rows.map((function(e){return e.uniqueName||e.uniquename})).join("~"),p>1){var a=e.datafor_rows.filter((function(e){return m.indexOf(e.level)>=0&&"true"!==String(e.issum)})).map((function(e){return e})).pop();if(e.datafor_rows.filter((function(e){return"true"==String(e.issum)})).length>p-1)e.parentId=null;else{var n=a.value,i=a.level,l=v(e,i),u=e.datafor_rows.filter((function(e){return m.indexOf(e.level)>=0})).map((function(e){return e.uniqueName})).join("~"),s=_.find(r,(function(e){var r=v(e,i),t=e.datafor_rows.filter((function(e){return m.indexOf(e.level)>=0})).map((function(e){return e.uniqueName})).join("~");return r&&l&&r==l&&u!=t}));e.parentId=s?s.id:null,e.datafor_tree_name=n}e.id=e.summarySeriesJoinName||e.myuuid,e.pq_close="true"!==String(e.isSummaryNode),a.level===m[m.length-1]&&delete e.shouldNextLoad}else e.id=t,1==m.length&&delete e.shouldNextLoad;return!0})),u.freezeCols=0,u.treeModel={dataIndx:"datafor_tree_name",checkbox:!1,checkboxHead:!1,cascade:!0,iconCollapse:["fa fa-caret-right","fa fa-caret-down"],summary:!1},u.freezeCols=0,u},ParamQueryTreePivot:function(e,r,t,a,n){var o,i,l=Array.prototype.slice.call(arguments,0),u=componentsUtils.ParamQueryLoadingPivot.apply(null,l),s=function e(r){return Array.isArray(r.colModel)&&0!==r.colModel.length?e(r.colModel[0]):r};return strayMethods.shiftGroupOuter(u.colModel),o=function(e){var r=_.find(u.colModel,{isColumnDimensionNode:!0,isColumnNameNode:!0});return r||(r=_.find(u.colModel,{isMeasureNode:!1})),{column:r,key:s(r).key}}(u.colModel),(i=o.column)&&(delete i.colModel,i.dataIndx="datafor_tree_name",i.title="名称",i.titleOrigin="名称",i.isTreeColumnNode=!0),function e(r,t){(r||[]).forEach((function(r,a){r.isMeasureNode?r.hidden=!1:(r.isColumnNameNode||t.isColumnNameNode||r.isGrand||r.isGroup||"numericIndex"===r.dataIndx?r.hidden=!1:r.hidden=!0,t.collapseModel=t.collapseModel||{on:r.hidden}),Array.isArray(r.colModel)&&r.colModel.length&&e(r.colModel,r)}))}(u.colModel,{isColumnNameNode:!0}),u.dataModel.data.every((function(e,r){e.datafor_rows[0];return e.datafor_tree_name=e[o.key],e.shouldNextLoad=!0,e.pq_close=!0,e.myuuid=e.datafor_rows.map((function(e){return e.uniqueName||e.uniquename})).join("~"),e.id=r,!0})),u.treeModel={dataIndx:"datafor_tree_name",checkbox:!1,checkboxHead:!1,cascade:!0,iconCollapse:["fa fa-caret-right","fa fa-caret-down"],summary:!1},u},BackbonePlainList:function(e,r,t,a){var n=Array.prototype.slice.call(arguments,0),o=componentsUtils.ParamQueryLoadingPivot.apply(null,n);return o.freezeCols=0,o},ParamQueryLoadingPivot:function(e,r,t,a,n,o){var i,l=null,u=null,s=1,d={pageModel:{},width:"100%",height:"100%",selectionModel:{type:"cell",mode:"single"},strNoRows:"",resizable:!1,sortModel:{single:!1,sorter:[],space:!1,multiKey:null,type:"local"},stripeRows:!0,editable:!1,title:null,labelNames:[],collapsible:{on:!1,toggle:!1},dragColumns:{enabled:!1},showTitle:!1,postRenderInterval:200,flex:{one:!0},bootstrap:{on:!0},showBottom:!0,mergeCells:[],wrap:!1,hwrap:!1,scrollModel:{autoFit:!1,horizontal:!0},dataModel:{data:r.map((function(e,r){var t,a,n,o,i=(a=e.datafor_rows||[],n=null,o=a.map((function(e){return e&&"true"===String(e.issum)&&(n=!0),e?e.value:""})).join("~"),n?o:null);for(var l in i&&(e.isSummaryNode=!0,e.summarySeriesJoinName=i),function(e){return e.filter((function(e){return e&&"true"===String(e.istotal)})).length>0}(e.datafor_rows||[])&&(e.isGrantSummary=!0),e)(t=e[l])&&t.hasOwnProperty("formatted")&&(e[l]=JSON.stringify(t));return e.isSummaryNode?e.numericIndex="":(e.numericIndex=Number(s),s++),e}))},numberCell:{show:!1}};d.colModel=function e(r){return r.forEach((function(r,t){r.dataIndx=r.dataIndex||r.key,r.titleOrigin=r.title,r.isMeasureNode?((String(r.dataIndx).match(/\[Measures\]\.\[Fact Count\]$/g)||String(r.dataIndx).match(/^\[Measures\]\.\[UUID-/g))&&(r.hidden=!0),r.halign="center",r.align="right"):(r.halign="center",r.align="left",Array.isArray(r.children)||(u&&(u.isLastDimensionNode=!1),r.isLastDimensionNode=!0,u=r)),r.hidden||(l=r),Array.isArray(r.children)&&(r.colModel=e(r.children))})),r}(e),l&&(l.isLastColumn=!0),d.colModel.unshift({dataIndx:"numericIndex",align:"center",width:60,title:""}),strayMethods.tryMergeGroupCell(d.colModel),d.colModel.push({dataIndx:"empty_column_scroll",title:"",hidden:!0});try{(i=_.findIndex(d.dataModel.data,"isGrantSummary"))>=0&&(i=d.dataModel.data.splice(i,1),d.summaryData=i)}catch(e){console.log(e.stack)}d.summaryLocation=o?"bottom":"top";var c=tryConcatMergeCell({colModel:d.colModel,b:d.dataModel.data,a:[],blocked:[],startColumn:1,isLast:a,summaryLocation:d.summaryLocation},!0);return d.mergeCells=c.merge,d.dataModel.data=c.added,d.blockedSummary=c.blocked,d.freezeCols=t.filter((function(e){return!e.isMeasureNode})).length+1,d}},dataUtils={getFormattedValue:function(e,r,t,a,n){var o=String(r.uniqueName||r.m||"").split("~").pop(),i=r.formatted,l=t||{};return!l.hasOwnProperty(o)||null!=r.value&&""!=r.value&&null!=r.value||(i=l[o]),i},autoParamQueryMerge:function(e,r,t,a){var n,o,i,l=_.find(r,(function(e){return e&&Array.isArray(e.datafor_rows)&&e.datafor_rows.length}))||{},u=(n=e,o=new Array,Array.isArray(n)&&function e(r,t,a){Array.isArray(r)&&r.forEach((function(r,n){r&&t(r,n),r.hasOwnProperty(a)&&Array.isArray(r[a])&&e(r[a],t,a)}))}(n,(function(e){Array.isArray(e.colModel)&&0!=e.colModel.length||["numericIndex","empty_column_scroll"].indexOf(e.dataIndex)<0&&(e.hidden||o.push(e))}),"colModel"),o);i=a||Array.isArray(l.datafor_rows)?l.datafor_rows.length+0:u.length-u.filter((function(e){return e.isMeasureNode})).length;var s=t||0;return JSON.stringify(function(e,r,t,a){for(var n,o=[],i=function(e,r,a){for(var n,o=!0;a-- >=0;)if("numericIndex"!==(n=t[a]?t[a].dataIndx:null)&&e[n]!==r[n]){o=!1;break}return o};e--&&e>=r;){var l=t[e].dataIndx,u=1,s=a.length,d=t[e-1]?t[e-1].dataIndx:null;for(d="numericIndex"==d?null:d;s--;){var c=a[s],f=a[s-1]||{},p=c[l],m=f[l];void 0!==m&&p==m?i(f,c,e)?u++:(n={r1:s,c1:e,rc:u,cc:1},o.push(n),u=1):u>1&&(n={r1:s,c1:e,rc:u,cc:1},o.push(n),u=1)}}return o}(i,s,u,r))},getJsonArray:function(e,r){var t,a,n,o,i=!1,l=r.emptyStrategy,u=r.formatMessage,s=r.standout,d=!!r.tableLike,c=r.chartType,f=r.colorsOption,p=r.customNames||[],m=e||{},v=r.query,y=r.hasDrilledDown,h=r.columnsLevels||[],g=r.locale||"zh",b=m.headNum||m.topOffset+1,M=m.cellset||[],x=m.query&&m.query.properties?m.query.properties["datafor.query.sum.bottom"]:null,N=!(null!==(t=JSON.parse(v))&&void 0!==t&&null!==(t=t.queryModel)&&void 0!==t&&null!==(t=t.details)&&void 0!==t&&null!==(t=t.measures)&&void 0!==t&&t.length),S=(r.sortMessage||[]).map((function(e){var r;return{id:e.id,uuid:e.uuid,type:null===(r=e.sort)||void 0===r?void 0:r.type}})),A=new Array,w=!0,C={};!1!==x&&(x=!0),M&&Array.isArray(M)&&0!==M.length||postMessage({isLast:!r.subsetMode||1!=m.hasNextPaging,isEmpty:w,columns:[],javaErr:m.error,queryUUID:m.query?m.query.name:null,columnLeafs:[],dataArray:[],data:null}),w=Boolean((m.height||0)-(m.headNum||0)<1),n=M.slice(0,b);try{timeLog("<<build columns>>"),o=function(e){var r=new Array;return e.forEach((function(e,t){var a,n=new Array;e.filter((function(e){return!!e})).forEach((function(t,o){var i,l,u,s,d,c,f,m,v,y,g,b,M,x=t.value,A=r[r.length-1];if("null"===x)if(t.properties&&0!==Object.keys(t.properties).length)c=x,d="null-"+o;else{var w=_.find(e,(function(e){return"null"!==e.value&&e.properties&&e.properties.level}));w?(c=strayMethods.getModelLeafNodeCaption(w.properties.level,1,p,"")||(_.find(h||[],{id:w.properties.level})||{}).label||"",f="right"):c="",d="null-"+(c||o)}else d=(null===(v=t.properties)||void 0===v?void 0:v.id)||(null===(y=t.properties)||void 0===y?void 0:y.uniquename)||(null===(g=t.properties)||void 0===g?void 0:g.level),c=strayMethods.getModelLeafNodeCaption(d,1,p,x)||x,null==d&&N&&(d="null-"+o);M=o,s=(b=A)?b.find((function(e){return e.datafor_start<=M&&e.datafor_end>=M})):null,m=d;var C,L,E,O=(null===(i=t.properties)||void 0===i?void 0:i.uniquename)||(null===(l=t.properties)||void 0===l?void 0:l.level);if(s&&(d=s.key+"~"+d),u=_.find(n,{key:d}))u.datafor_end+=1;else{var k,z,I;a=_.extend({levelCaption:"",value:t.value,axis:"column",uniqueName:t.properties.uniquename},t.properties),u=_.extend({datafor_start:o,datafor_end:o},{key:d,filled:w,uniqueName:(null===(k=t.properties)||void 0===k?void 0:k.uniquename)||(null===(z=t.properties)||void 0===z?void 0:z.level),dataIndex:d,isColumnNameNode:!!f,hidden:!!String(d).split(/~/g).pop().match(/^\[Measures\]\.\[UUID-/),title:(C=c,L="true"===String(t.properties.issum),E="true"===String(t.properties.istotal),E?C:L?(s&&s.isGrand,C):C),isGroup:"true"===String(t.properties.issum)||!(!s||!s.isGroup),isGrand:"true"===String(t.properties.istotal)||!(!s||!s.isGrand),isMeasureNode:t.properties&&"Measures"===t.properties.dimension&&"[Measures]"===t.properties.hierarchy||"DATA_CELL"===t.type,width:120,format:null===(I=t.properties)||void 0===I?void 0:I.format,datafor_properties:s?s.datafor_properties.concat(a):[a]}),t.type&&["COLUMN_HEADER","ROW_HEADER"].indexOf(t.type)>=0&&!1===u.isMeasureNode&&(u.isColumnDimensionNode=!0);var q,T=S.find((function(e){var r=e.id,t=e.uuid;return r!==t?m==t:O==r}));T?(q=String(T.type).toLowerCase(),["asc","desc"].indexOf(q)<0&&(q="all"),u.isMeasureNode&&s&&!u.isGrand?u.orderedType=!1:u.orderedType=q):u.isMeasureNode?s&&!u.isGrand?u.orderedType=!1:u.orderedType="all":u.isColumnDimensionNode?u.isColumnNameNode?(T=_.find(S,{id:w?w.properties.level:null}))?(q=String(T.type).toLowerCase(),["asc","desc"].indexOf(q)<0&&(q="all"),u.orderedType=q):u.orderedType="all":u.orderedType=!1:u.orderedType="all",n.push(u)}s&&(Array.isArray(s.children)?_.find(s.children,{key:u.key})||s.children.push(u):s.children=[u])})),r.push(n)})),r[0]}(n)||[],timeLogEnd("<<build columns>>"),function e(r,t){Array.isArray(r)&&r.forEach((function(r,a){Array.isArray(r.children)?e(r.children,t):t(r)}))}(o,(function(e){var r=e.datafor_properties.filter((function(e){return e&&Object.keys(e).length&&"[Measures]"!==e.hierarchy&&e.hasOwnProperty("uniquename")}));C[e.datafor_start]={key:e.key,uniqueName:e.uniqueName,title:e.title,isMeasureNode:e.isMeasureNode,datafor_columns:r,format:e.format}}));var L=!0;timeLog("<<build datasets>>"),M.slice(b).forEach((function(e,r){var t={datafor_rows:[]};L=!0,e.forEach((function(r,a){var n,o,i,c=C[a];c&&(n=c.key||a+1,"DATA_CELL"===r.type?(i=r.properties||{},o=dataUtils.getFormattedValue(u,{uniqueName:n,value:i.raw,formatted:r.value},l,d?s:null,g),t[n]={raw:r.properties?r.properties.raw:r.value,formatted:o,vtip:i.hasOwnProperty("sourceVal")?i.sourceVal:r.value},t[n].uniqueName=r.properties.uniquename||r.properties.uniqueName||t[n].vtip):!r.properties||0===Object.keys(r.properties).length&&"null"===r.value?e[a-1]&&e[a-1].properties&&"true"===String(e[a-1].properties.issum)&&"ROW_HEADER"===r.type?(t[n]=r.value,r.properties=_.extend(r.properties||{},{issum:"true",level:n.split("~").pop(),uniquename:"null"})):t[n]="":"true"===String(r.properties.issum)&&"ROW_HEADER"===r.type?L?(t[n]=r.value,L=!1):t[n]="":t[n]=r.value,r.properties&&(r.properties.uniquename||r.properties.issum)&&"[Measures]"!=r.properties.hierarchy&&t.datafor_rows.push(_.extend({value:r.value,levelCaption:c.title,uniqueName:r.properties.uniquename,level:r.properties.level||c.key,hierarchy:r.properties.hierarchy||String(c.key).replace(".["+c.title+"]",""),axis:"row"},r.properties)))})),A.push(t)})),timeLogEnd("<<build datasets>>"),d||(timeLog("<<color calculate>>"),dataUtils.setRowColorAndTooltip(A,m,f,o,v,{hasDrilledDown:y}),timeLogEnd("<<color calculate>>")),timeLog("component package"),(a=componentsUtils[c]?componentsUtils[c](o,A,_.values(C),m.pageRec<m.pageSize,r,x,{members:(e||{}).uniqueLevels||{},levelMetas:(e||{}).levelMetas||{},raw:m}):null)&&!0===a.isVirualEmpty&&(w=!0,A=[]),timeLogEnd("component package")}catch(e){i="Worker error:"+e.stack}postMessage({isLast:!r.subsetMode||1!=m.hasNextPaging,record:r.subsetMode?{nextCount:m.nextCount,nextPagingStart:m.nextPagingStart,nextStart:m.nextStart}:{},isEmpty:w,javaErr:m.error,columns:o,color:m.colorArray,icon:m.iconArray,formatAsPivot:m.formatAsPivot,tooltips:m.tooltipArray,columnLeafs:JSON.parse(JSON.stringify(C)),queryUUID:m.query?m.query.name:null,dataArray:A,data:a,error:i})},setRowColorAndTooltip:function(e,r,t,a,n,o){var i,l,u,s,d=t.configs,c=void 0===d?{}:d,f=t.colors,p=void 0===f?[]:f;if(null!==(i=r.colorArray)&&void 0!==i&&i.length){var m=r.colorArray,v=Object.keys(m[0]).find((function(e){return"toLink"!=e}));if(!String(v).match(/^\[/)){var y=c.type,h=c.customize,g=c.continues,b=void 0===g?{}:g,M=c.rules,x=void 0===M?[]:M,N=c.based,S=void 0===N?{}:N;if(0==h);else if(Object.keys(b).length<2&&(null==x?void 0:x.length)<1){var A="#E1F5FE",w="#4285F4",C=m.map((function(e){var r;return(null===(r=e[v])||void 0===r?void 0:r.raw)||0})),L=Math.min.apply(Math,_toConsumableArray(C)),E=Math.max.apply(Math,_toConsumableArray(C))-L;m.forEach((function(e){var r=e[v],t=r.raw;r.value;e.color=tinycolor.mix(A,w,100*(t-L)/E||0).toHexString()})),postMessage({isProgressEvent:!0,progress:{colorsOption:_objectSpread(_objectSpread({},c),{},{continues:{min:A,max:w},type:"continues",customize:!0}),colorKey:v},code:null})}else if("continues"==y){var O=b.min,k=b.max;if(((null==S?void 0:S.uuid)||(null==S?void 0:S.measure))!==v);else{var z=m.map((function(e){var r;return(null===(r=e[v])||void 0===r?void 0:r.raw)||0})),I=Math.min.apply(Math,_toConsumableArray(z)),q=Math.max.apply(Math,_toConsumableArray(z))-I;m.forEach((function(e){var r=e[v],t=r.raw;r.value;e.color=tinycolor.mix(O,k,100*(t-I)/q||0).toHexString()}))}}else if("discrete"==y){((null==S?void 0:S.uuid)||(null==S?void 0:S.measure))!==v||x.length&&m.forEach((function(e){var r=e[v].raw,t=void 0===r?0:r,a=_.find(x,(function(e){var r=e.start_value,a=e.end_value,n=Boolean(_.isFunction(calculateMap[e.start])&&calculateMap[e.start](r,t));return n&&_.isFunction(calculateMap[e.end])&&(n=calculateMap[e.end](a,t)),n}));e.color=null==a?void 0:a.color}))}}else{var T,P,j={},J=!(null==o||!o.hasDrilledDown),D=null==e||null===(T=e.find((function(e){var r;return null==e||null===(r=e.datafor_rows)||void 0===r?void 0:r.length})))||void 0===T?void 0:T.datafor_rows;if(J&&(null==D?void 0:D.length)>1&&null!=D&&D.find((function(e){return v.includes(null==e?void 0:e.level)})))m.forEach((function(e,r){e.color=p[r%p.length]}));else if(m.forEach((function(e){var r=e[v].value;j.hasOwnProperty(r)||(j[r]=p[Object.keys(j).length%p.length]),e.color=j[r]})),null!=c&&c.customize&&"category"==(null==c?void 0:c.type)&&null!=c&&null!==(P=c.categories)&&void 0!==P&&P.length){var U=c.categories;m.forEach((function(e,r){var t=e[v],a=t.value,n=t.raw,o=U.find((function(e){var r=e.key;return r==a||r==n}));e.color=(null==o?void 0:o.color)||e.color}))}else{var V=Object.keys(j).map((function(e){return{key:e,color:j[e]}}));postMessage({isProgressEvent:!0,progress:{colorsOption:_objectSpread(_objectSpread({},c),{},{categories:V,type:"category"}),colorKey:v},code:null})}}e.forEach((function(e){var r=strayMethods.getSequenceKeys(e.datafor_rows),t=m.find((function(e){return e.toLink.sort((function(e,r){return String(e).localeCompare(String(r))})).join("...")===r}));t?(e.color=t.color,Object.keys(e).filter((function(e){return String(e).match(/^\[Measures\]\.\[/)})).reduce((function(r,t){return r[t]=_objectSpread({},e[t]||{}),r}),t)):e.color=null}))}else;if(!(l=n,(null==(s=JSON.parse(l))||null===(u=s.queryModel)||void 0===u||null===(u=u.axes)||void 0===u||null===(u=u.COLUMNS)||void 0===u?void 0:u.length)>0)){a.map((function(e){return e.key}));var F=a.reduce((function(e,r){return e[r.key]=r.title,e}),{}),G=r.tooltipArray,R=a.filter((function(e){return e.isMeasureNode})).length>1;e.forEach((function(e){var r=[];if(a.forEach((function(t){var a=t.key,n=t.isMeasureNode,o=e[a],i={caption:F[a],value:o,id:a};n&&(i.value=null==o?void 0:o.vtip,R&&(i.only=a)),r.push(i)})),null!=G&&G.length){var t=strayMethods.getSequenceKeys(e.datafor_rows),n=G.find((function(e){var r=e.toLink;return 0==r.length||r.sort((function(e,r){return String(e).localeCompare(String(r))})).join("...")===t}));n&&Object.keys(n).filter((function(e){return"toLink"!=e})).forEach((function(e){var t;(null===(t=n[e])||void 0===t?void 0:t.caption)&&r.push({caption:n[e].caption,value:n[e].value,id:e})}))}e.tip={rows:r}}))}}};function getLocationFromPlace(e){var r,t,a,n,o=e.tileType||"osm",i=e.type,l=e.key,u=e.geocodeURL,s=Math.min(Number(e.interval)||5,5),d={error:[]},c=function(e,t,a,n,o,i){Array.isArray(e)&&e.length?(r||(r=setInterval((function(){postMessage({isProgressEvent:!0,progress:{value:Number(100*(t-e.length)/t).toFixed(0),response:d},code:a.status})}),1e3)),setTimeout((function(){o(i)}),n)):(clearInterval(r),i(a.status))},f=(e.datasets||[]).map((function(e){return e.city=e.city||"World",e.name=e.name||e.caption,e})),p=function(e){return e.filter((function(e){return"boundary"===i?!e.hasOwnProperty("boundary")||(d[e.name]=e,!1):!e.latitude||!e.longitude||(d[e.name]=e,!1)}))},m=function(){var e=JSON.parse(JSON.stringify(p(f))),t=e.length,a=function a(n){var o,l=e.shift(),s=u||"https://nominatim.openstreetmap.org/search",f=new XMLHttpRequest;f.onreadystatechange=function(){var r,o,u=Object.assign({},l);if(d[l.name]=u,4==f.readyState){if(200==f.status)try{r=JSON.parse(f.responseText),(o=_.find(r||[],{class:"boundary"})||{})||(o=_.find(r||[],{class:"place"})||{}),u.longitude=o.lon,u.latitude=o.lat,"boundary"===i&&(u.boundary=o.geojson)}catch(e){}c(e,t,f,1300,a,n)}},l?(o=s+"?_t=".concat(Date.now(),"&q=")+l.name+"&format=json&limit="+("boundary"==i?1:5),"boundary"===i&&(o+="&polygon_geojson=1"),f.open("GET",o),f.send()):(clearInterval(r),n(200))};return new Promise((function(r){e.length?a((function(e){d.code=e,r(d)})):r(Object.assign(d||{},{code:code}))}))};return postMessage({isProgressEvent:!0,progress:{value:0,response:{}},code:200}),"osm"===o?m().then((function(e){postMessage(e)})):"google"===o?(t=JSON.parse(JSON.stringify(p(f))),a=t.length,n=function e(n){var o,i=t.splice(0,1),f=(u||"https://maps.googleapis.com/maps/api/geocode/json")+"?_t=".concat(Date.now(),"&address="),p=new XMLHttpRequest,m=s||20;p.onreadystatechange=function(){var r;if(4==p.readyState){if(200==p.status)try{r=JSON.parse(p.responseText),Array.isArray(r.results)&&r.results.length?i.forEach((function(e,t){var a,n,o=e.name,i=_.find(r.results,(function(e){return String(e.formatted_address).indexOf(o)>=0}));i||(i=r.results[0]),i&&(n=Object.assign({},e),d[o]=n,a=i.geometry.location,n.longitude=a.lng,n.latitude=a.lat)})):r.error_message&&d.error.indexOf(r.error_message)<0&&d.error.push(r.error_message)}catch(e){}c(t,a,p,m,e,n)}},0===i.length?(clearInterval(r),n(200)):(o=f+i.map((function(e){return e.name})).join(";")+"&key="+l,p.open("GET",o),p.send())},new Promise((function(e){t.length?n((function(r){d.code=r,e(d)})):e(Object.assign(d||{},{code:code}))}))).then((function(e){postMessage(e)})):"gaode"===o||"amap"===o?function(){var e=JSON.parse(JSON.stringify(p(f))),t=e.length,a=s||5,n=function n(o){var i,s=e.splice(0,10),f=(u||"https://restapi.amap.com/v3/geocode/geo")+"?_t=".concat(Date.now(),"&batch=true&output=JSON&address="),p=new XMLHttpRequest;p.onreadystatechange=function(){var r;if(4==p.readyState){if(200==p.status)try{r=JSON.parse(p.responseText),Array.isArray(r.geocodes)&&r.geocodes.length&&s.forEach((function(e,t){var a,n,o=e.name,i=r.geocodes[t];i&&(n=Object.assign({},e),d[o]=n,a=String(i.location).split(",").map((function(e){return Number(String(e).replace(/^\s+|\s+$/g,""))})),n.longitude=a[0],n.latitude=a[1])}))}catch(e){}c(e,t,p,a,n,o)}},0===s.length?(clearInterval(r),o(200)):(i=f+s.map((function(e){return e.name})).join("|")+"&key="+l,p.open("GET",i),p.send())};return new Promise((function(r){e.length?n((function(e){d.code=e,r(d)})):r(Object.assign(d||{}))}))}().then((function(e){postMessage(e)})):"mapbox"===o?function(){var e=JSON.parse(JSON.stringify(p(f))),t=e.length,a={count:1,endpoint:"mapbox.places"},n=a.count,o=a.endpoint,i=s||20,m=function a(s){var f,p=e.splice(0,n),m=u||"https://api.mapbox.com/geocoding/v5/".concat(o,"/"),v=new XMLHttpRequest;v.onreadystatechange=function(){if(4==v.readyState){if(200==v.status)try{var r=JSON.parse(v.responseText),n=r.features;if(r.query,null!=n&&n.length){var o=_slicedToArray(n,1),l=_slicedToArray(o[0].center,2),u=l[0],f=l[1];u&&f&&p.forEach((function(e,r){var t,a=e.name;t=Object.assign({},e),d[a]=t,t.longitude=u,t.latitude=f}))}}catch(e){}c(e,t,v,i,a,s)}},0===p.length?(clearInterval(r),s(200)):(f=m+p.map((function(e){return e.name})).join(";")+".json?access_token=".concat(l,"&limit=1&_t=").concat(Date.now()),v.open("GET",f),v.send())};return new Promise((function(r){e.length?m((function(e){d.code=e,r(d)})):r(Object.assign(d||{}))}))}().then((function(e){postMessage(e)})):m().then((function(e){postMessage(e)}))}function dataNormalTranslate(e){var r;try{r=dataUtils.getJsonArray(e.data,e.attrs)}catch(e){console.log(e.stack)}return r}function tryConcatMergeCell(e,r){var t,a,n,o=JSON.parse(JSON.stringify(e.a)),i=e.b||[],l=e.isLast,u=i,s=e.blocked||[];if("bottom"==(e.hasOwnProperty("summaryLocation")?e.summaryLocation:"bottom"))if(l);else{if(s.length){var d=function(e,r){for(var t,a=e.length,n=0;n<a;n++){if("true"!==String(e[n].isSummaryNode)){t=e[n];break}r.indexOf(e[n].summarySeriesJoinName)>=0&&(e.splice(n,1),n--)}return t}(i,s.map((function(e){return e.summarySeriesJoinName})));s.reverse().forEach((function(e,r){d[e.toCompareKey]===e.theLastValue||i.unshift(e)}))}s=function(e){for(var r=e.length,t=[],a={};r--;){if("true"!==String(e[r].isSummaryNode)){a=e[r];break}t=t.concat(e.splice(r,1))}return t.forEach((function(e,r){var t=_.findIndex(e.datafor_rows,{issum:"true"}),n=e.datafor_rows[t-1].level;e.toCompareKey=n,e.theLastValue=a[n]})),t}(i).reverse()}else o.length&&u.length&&(a=u,n=o.filter((function(e){return e&&e.isSummaryNode&&e.summarySeriesJoinName})).map((function(e){return e.summarySeriesJoinName})),u=a.filter((function(e){return!(e&&e.summarySeriesJoinName&&n.indexOf(e.summarySeriesJoinName)>=0)})));if(o.concat(u).length&&(t=dataUtils.autoParamQueryMerge(e.colModel,o.concat(u),e.startColumn)),r)return{merge:t,added:u,blocked:s};postMessage({merge:t,added:u,blocked:s})}addEventListener("message",(function(e){var r=e.data;switch(r.type){case"GetLocationFromPlace":getLocationFromPlace(r.data);break;case"dataNormalTranslate":dataNormalTranslate(r.data);break;case"tryMergeCell":tryConcatMergeCell(r.data);break;case"tryGetConditionColor":getConditionalColor(r.data);break;case"tryExtractAssistFields":tryExtractAssistFields(r.data);break;case"tryGetCoordinateChartOptions":tryGetCoordinateChartOptions(r.data)}}));var splitNumberMap=[{fn:function(e){return e<120},value:1},{fn:function(e){return 120<=e&&e<240},value:2},{fn:function(e){return 240<=e&&e<320},value:3},{fn:function(e){return 320<=e&&e<460},value:4},{fn:function(e){return 460<=e&&e<680},value:5},{fn:function(e){return 680<=e},value:6}],getNumberLocaleLength=function(e,r,t,a){var n,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"en",i=function(e){var t=String(r).split("."),n=t.length<2?0:String(t[1]).length;return a?Number(100*e).toFixed(Math.max(0,n-2))+"%":Number(e).toFixed(n)},l=[{locales:["en","en-US"],template:[{fn:function(e){return e<1e3},value:function(e){return getTextSize(String(i(e)),t)}},{fn:function(e){return 1e3<=e&&e<1e6},value:function(e){return getTextSize(String(a?i(e):i(e/1e3)+"K"),t)}},{fn:function(e){return 1e6<=e&&e<1e9},value:function(e){return getTextSize(String(a?i(e):i(e/1e6)+"M"),t)}},{fn:function(e){return 1e9<=e},value:function(e){return getTextSize(String(a?i(e):i(e/1e9)+"B"),t)}}]},{locales:["zh","zh-CN","zh-TW"],template:[{fn:function(e){return e<1e4},value:function(e){return getTextSize(String(i(e)),t)}},{fn:function(e){return 1e4<=e&&e<1e6},value:function(e){return getTextSize(String(a?i(e):i(e/1e4)+"万"),t)}},{fn:function(e){return 1e6<=e&&e<1e8},value:function(e){return getTextSize(String(a?i(e):i(e/1e6)+"百万"),t)}},{fn:function(e){return 1e8<=e},value:function(e){return getTextSize(String(a?i(e):i(e/1e8)+"亿"),t)}}]}],u=((null===(n=l.find((function(e){return e.locales.includes(o)})))||void 0===n?void 0:n.template)||l[0].template).find((function(e){return(0,e.fn)(r)}));return u?u.value(e):getTextSize(String(e),t)},getTextSize=function(e,r){var t=new OffscreenCanvas(1,1).getContext("2d");return t.font="".concat(r,"px sans-serif"),t.measureText(e).width},getLegendMessage=function(e){for(var r,t,a=e.show,n=e.data,o=void 0===n?[]:n,i=e.textStyle,l=(void 0===i?{}:i).fontSize,u=void 0===l?12:l,s="vertical"==e.orient?e.itemWidth:e.itemHeight,d=!!a&&(null==o?void 0:o.length)>0,c=0,f=0,p=o.length;p--;){var m=o[p].name,v=String(m).length;v>f&&(f=v,c=m)}return"vertical"==e.orient?(r=e.hasOwnProperty("left")?"left":"right",t=getTextSize(c,u)+s+10+5):(r=e.hasOwnProperty("top")?"top":"bottom",t=u+10+5),{size:d?Number(t):0,position:r}},getAxisLabelMessage=function(e,r,t,a,n,o){var i=e.axisLabel,l=void 0===i?{}:i,u=!(null==l||!l.show);"value"!=e.type||null!=e.axisMin||null!=e.axisMax||n||(u=!1);if(r){var s,d,c,f,p,m,v;if(!u)return{size:10};if(t)d=getNumberLocaleLength(t,a,Number((null===(c=e.axisLabel)||void 0===c||null===(c=c.textStyle)||void 0===c?void 0:c.fontSize)||12),null===(f=e.formats)||void 0===f?void 0:f.find((function(e){return String(e).match(/\%/g)})),o),d+=15;else if(e.axisMaxLabel)if(s=e.axisMaxLabel,null!=l&&l.dataforLabelSize)d=l.dataforLabelSize+10+10;else d=getTextSize(s,Number((null===(p=e.axisLabel)||void 0===p||null===(p=p.textStyle)||void 0===p?void 0:p.fontSize)||12))+10+10;else d=getNumberLocaleLength(Math.max(Math.abs(e.axisMin||0),Math.abs(e.axisMax||0),Math.abs(e.min||0),Math.abs(e.max||0)),a,Number((null===(m=e.axisLabel)||void 0===m||null===(m=m.textStyle)||void 0===m?void 0:m.fontSize)||12),null===(v=e.formats)||void 0===v?void 0:v.find((function(e){return String(e).match(/\%/g)})),o),d+=20;return{size:d}}var y,h=10+("value"==e.type?6:0);if(!u)return{size:h};var g=(null==l?void 0:l.rotate)||0,b=(null==l?void 0:l.dataforLabelSize)||(null==l?void 0:l.width)||60,M=Number((null==l||null===(y=l.textStyle)||void 0===y?void 0:y.fontSize)||12);return{size:g>0?b*Math.sin(g*Math.PI/180)+h+3:M+h}},getAxisYLabelGroupSize=function(e,r,t,a,n){var o=e.find((function(e){return!!e.dataforMerged}))?{axisMin:Math.min.apply(Math,_toConsumableArray(e.map((function(e){return e.axisMin})))),axisMax:Math.max.apply(Math,_toConsumableArray(e.map((function(e){return e.axisMax}))))}:{},i=[],l=0,u=0;return e.forEach((function(e,s){var d=o.hasOwnProperty("axisMin")?o.axisMin:e.axisMin,c=o.hasOwnProperty("axisMax")?o.axisMax:e.axisMax;if(d&&c){var f,p,m=strayMethods.getProperMinMax(d,c,r,t,!e.dataforZeroAlign),v=m.min,y=m.max,h=m.interval,g=getAxisLabelMessage(e,!0,Math.max(Math.abs(v),Math.abs(y)),h,t,a).size;if(0==s){if(l+=g+n,i.push(g),e.showDataforAxisName)l+=Number((null===(f=e.nameTextStyle)||void 0===f?void 0:f.fontSize)||12)+5}else if(u+=g+n,i.push(g),e.showDataforAxisName)u+=Number((null===(p=e.nameTextStyle)||void 0===p?void 0:p.fontSize)||12)+5}})),{nameGaps:i,left:l,right:u}},tryGetCoordinateChartOptions=function(e){var r=e.yAxis,t=e.xAxis,a=e.sizex,n=e.sizey,o=e.grid,i=e.styleProperties,l=void 0===i?{}:i,u=e.locale,s=e.isCoordinatedChart,d=Array.isArray(r)?r:[r],c=Array.isArray(t)?t:[t],f=d.find((function(e){return"value"==e.type})),p=[],m=[],v=[],y=[],h=[],g={},b={},M=20;o.left=5,o.right=10,o.top=15,o.bottom=10,o.containLabel=!1;var x=getLegendMessage(e.legend),N=x.position,S=x.size;"left"==N?o.left+=S:"right"==N?o.right+=S:"top"==N?o.top+=S:o.bottom+=S;var _=l||{},A=_.enableNumericAxisZoom,w=void 0!==A&&A,C=_.boundaryGroupSize,L=void 0===C?20:C,E=_.isRatioStackMode,O=void 0!==E&&E,k=w?10:0;if(s)if(f&&c.find((function(e){return"value"==e.type})),f){var z,I,q,T=getTextSize(t.axisMaxLabel||"",Number((null===(z=t.axisLabel)||void 0===z||null===(z=z.textStyle)||void 0===z?void 0:z.fontSize)||12))+10;if(isNaN(null===(I=t.axisLabel)||void 0===I?void 0:I.dataforRotate)&&"category"==t.type){var P=getAxisYLabelGroupSize(d,5,O,u,k),j=P.left,J=P.right,D=(a-o.left-o.right-j-J)/t.data.length,U=t.axisLabel.dataforLabelSize||Math.ceil(.25*n);D<T?(g.rotate=t.axisLabel.rotate=30,g.size=t.axisLabel.dataforLabelSize=Math.min(T,U)):(U=Math.max(D,U),g.rotate=t.axisLabel.rotate=0,g.size=t.axisLabel.dataforLabelSize=Math.min(T,U)),g.size=Math.max(40,g.size)}else{var V,F;g.rotate=t.axisLabel.rotate=t.axisLabel.dataforRotate||0;var G=Math.min(T,t.axisLabel.dataforLabelSize||getTextSize(t.axisMaxLabel||"",Number((null===(V=t.axisLabel)||void 0===V||null===(V=V.textStyle)||void 0===V?void 0:V.fontSize)||12))+10);t.axisLabel.dataforLabelSize=Math.max(40,G),g.size=null===(F=t.axisLabel)||void 0===F?void 0:F.dataforLabelSize}var R=getAxisLabelMessage(t).size;y.push(R+("value"==t.type?0:"bottom"==x.position&&x.size>0?10:5)),o.bottom+=R;var B=n-o.bottom-o.top,H=(null===(q=splitNumberMap.find((function(e){return(0,e.fn)(B)})))||void 0===q?void 0:q.value)||1,Q=c.find((function(e){return!!e.type}))||{},K=Q.showDataforAxisName,W=Q.nameTextStyle;if(K){var Y=(void 0===W?{}:W).fontSize,$=void 0===Y?12:Y;o.bottom+=Number($)+5}var Z,X=d.find((function(e){return!!e.dataforMerged}))?{axisMin:Math.min.apply(Math,_toConsumableArray(d.map((function(e){return e.axisMin})))),axisMax:Math.max.apply(Math,_toConsumableArray(d.map((function(e){return e.axisMax}))))}:{};if(d.forEach((function(e,r){var t=X.hasOwnProperty("axisMin")?X.axisMin:e.axisMin,a=X.hasOwnProperty("axisMax")?X.axisMax:e.axisMax;if(["null","undefined"].indexOf(String(t))>=0||["null","undefined"].indexOf(String(a))>=0)return 0==r?o.left+=10:o.right+=10,void h.push(10);var n=strayMethods.getProperMinMax(t,a,H,O,!e.dataforZeroAlign),i=n.min,l=n.max,s=n.interval;p.push({min:i,max:l,interval:s}),v.push(H);var d,c,f=getAxisLabelMessage(e,!0,Math.max(Math.abs(i),Math.abs(l)),s,O,u).size;0==r?(h.push(f),o.left+=f+k+5,e.showDataforAxisName&&(o.left+=Number((null===(d=e.nameTextStyle)||void 0===d?void 0:d.fontSize)||12)+5)):(o.right+=f+k,h.push(f),e.showDataforAxisName&&(o.right+=Number((null===(c=e.nameTextStyle)||void 0===c?void 0:c.fontSize)||12)+5))})),"category"!=t.type)M=Number.POSITIVE_INFINITY,o.bottom+=k;else M=Math.floor((a-o.left-o.right)/L),(null===(Z=t.data)||void 0===Z?void 0:Z.length)-1>M?o.bottom+=15:o.bottom+=0}else{var ee,re;r.axisLabel.dataforLabelSize||(r.axisLabel.dataforLabelSize=Math.ceil(.25*a));var te=getTextSize(r.axisMaxLabel||"",Number((null===(ee=r.axisLabel)||void 0===ee||null===(ee=ee.textStyle)||void 0===ee?void 0:ee.fontSize)||12))+10;r.axisLabel.dataforLabelSize=Math.min(te,r.axisLabel.dataforLabelSize);var ae,ne=getAxisLabelMessage(r,!0).size;if(b.size=r.axisLabel.dataforLabelSize,o.left+=ne,r.showDataforAxisName)h.push(ne-5),o.left+=Number((null===(ae=r.nameTextStyle)||void 0===ae?void 0:ae.fontSize)||12);var oe=a-o.left-o.right,ie=(null===(re=splitNumberMap.find((function(e){return(0,e.fn)(oe)})))||void 0===re?void 0:re.value)||1;c.forEach((function(e,r){var t=strayMethods.getProperMinMax(e.axisMin,e.axisMax,ie,O,!e.dataforZeroAlign),a=t.min,n=t.max,i=t.interval;m.push({min:a,max:n,interval:i}),v.push(ie);var l,s,d=getAxisLabelMessage(e,!1,Math.max(Math.abs(a),Math.abs(n)),i,O,u).size;0==r?(o.bottom+=d+k,e.showDataforAxisName&&(y.push(d),o.bottom+=Number((null===(l=e.nameTextStyle)||void 0===l?void 0:l.fontSize)||12))):(o.top+=d,e.showDataforAxisName&&(y.push(d),o.top+=Number((null===(s=e.nameTextStyle)||void 0===s?void 0:s.fontSize)||12)))})),M=Math.floor((n-o.top-o.bottom)/L),"category"==r.type&&r.data.length-1>M&&(o.left+=15)}var le={closed:[]};o.left+o.right+5>a&&(le.grid=_objectSpread({},o),le.grid.left=15,le.grid.right=15,le.closed.push("yAxis"),["left","right"].includes(x.position)&&(le.closed.push("legend"),x.size=0)),o.top+o.bottom+5>n&&(le.grid=le.grid||_objectSpread({},o),le.grid.top=15,le.grid.bottom=15,le.closed.push("xAxis"),["top","bottom"].includes(x.position)&&(le.closed.push("legend"),x.size=0)),self.postMessage({yAxisScale:p,xAxisScale:m,splitNumber:v,xNameGap:y,yNameGap:h,confinedSpace:le,xAxisLabel:g,yAxisLabel:b,grid:_objectSpread({},o),groupNumPerScreen:M,legendMsg:x})};
//# sourceMappingURL=task.min.js.map