importScripts("task.min.js");var dictMap={};function deepFind(e,r,n){var i=null;return Array.isArray(e)?(e.every((function(e,t){return e&&r(e,t)?(i=e,!1):(e.hasOwnProperty(n)&&Array.isArray(e[n])&&(i=deepFind(e[n],r,n)),!i)})),i):i}function deepParents(e,r,n){var i=[],t=function(e,r,n){Array.isArray(e)&&e.forEach((function(e,a){e&&r(e,a)&&i.push(e),e.hasOwnProperty(n)&&Array.isArray(e[n])&&t(e[n],r,n)}))};return t(e,r,n),i}function flatplane2Tree(e,r,n,i,t,a){var l,u=[],o=a.filter((function(e){return 1!=e.isMeasureNode})).map((function(e){return e.key||e.uniqueName})),c=function(e,r,n,a,l,u,c,d,s,y){var f,p;0===e.filter((function(e){return e.idKey===s&&e.pKey===d})).length&&(f={caption:n,key:r,idKey:s,linkKey:a,name:n,children:[],id:r,pKey:d,myuuid:l?l+"~"+r:r,uniqueName:r,hierarchyUniqueName:u.hierarchy,hierarchy:u.hierarchy,levelUniqueName:String(u.level).replace(u.hierarchy,"").replace(/^\.|\[|\]/g,""),level:u.level,datafor_rows:o.map((function(e){var r=_.find(y,(function(r){return r.properties&&r.properties.level===e}))||{};return _.extend({},r.properties||{},{levelCaption:r.value,uniqueName:(r.properties||{}).uniquename,axis:"row"})})),mArray:c.filter((function(e){return!0})),extroArray:c},p=f,c.forEach((function(e,r){var n=i[r];if(n){var a=n.key||n.uniqueName;if(n.isMeasureNode){var l={value:Number((e.properties||{}).raw),formatted:e.value};p[a]=l.formatted,t[a]=t[a]||[],t[a].push({v:l.value,f:l.formatted,linkKey:p.linkKey,id:p.myuuid,caption:p.caption,pKey:p.pKey,level:String(p.myuuid).split("~").length})}else p[a]=e.value}})),dictMap.hasOwnProperty(a)||(dictMap[a]={position:f}),e.push(f))};if(!Array.isArray(e.cellset)||0===e.cellset.length)return console.log(">>空数据"),u;if(0===(l=e.cellset.slice(e.headName)).length)return console.log(">>空数据"),u;l.every((function(e){return function(e){if(!(e.length<3)){var r=e[0].value,n=e[2].value,i=e[2].properties,t=e[2].properties.uniquename,a=e[1].properties.uniquename,l=e[1].value,o=deepParents(u,(function(e,n){return e.linkKey==r}),"children");0===o.length?c(u,t,n,l,null,i,e.slice(3),r,a,e):o.forEach((function(r){r.children=r.children||[],c(r.children,t,n,l,r.myuuid,i,e.slice(3),r.linkKey,a,e)}))}}(e),!0})),u.forEach((function(e){var r=e.pKey,n=e.linkKey;if(""==r||r===n)return!0;var i=deepParents(u,(function(e){return e.linkKey===r}),"children");i.length&&(i.forEach((function(r){var n=JSON.parse(JSON.stringify(e));r.children=r.children||[],n.myuuid=r.myuuid+"~"+n.myuuid,r.children.push(n),Array.isArray(n.children)&&deepFind(n,(function(e){e.myuuid=r.myuuid+"~"+e.myuuid}),"children")})),e.toDelete=!0)})),u=u.filter((function(e){return!0!==e.toDelete}));return deepFind(u,(function(e){Array.isArray(e.children)&&0===e.children.length&&delete e.children}),"children"),u}var getExtroFieldArray=function(e,r){var n=["parent.key.field","child.key.field","caption.key.field"].map((function(n){return rCrossJoin.getCrossField(e,r,n)})).filter((function(e){return!!e})).map((function(e){return e.key}));return e.filter((function(e){return n.indexOf(e.key)<0}))};componentsUtils.BaseClosureTreeTable=function(e,r,n,i,t,a,l){var u=JSON.parse(t.query),o=rCrossJoin.getCrossField(e,u,"caption.key.field"),c=getExtroFieldArray(e,u),d=l.raw,s={colModel:[{dataIndx:"caption",title:"",titleOrigin:o?o.title:"",align:"left",halign:"left"}].concat(c.map((function(e){return{dataIndx:e.key,title:e.title,titleOrigin:e.title,isMeasureNode:e.isMeasureNode,align:e.isMeasureNode?"right":"center",halign:"center"}})))},y={};!d||!Array.isArray(d.cellset)||d.cellset.filter((function(e){return Array.isArray(e)&&_.find(e,(function(e){return e&&("DATA_CELL"===e.type||"ROW_HEADER"===e.type)}))})).length,datasets=flatplane2Tree(d,{},{},c,y,e),s.dataModel=s.dataModel||{},s.dataModel.data=datasets.filter((e=>void 0!==e.id&&null!==e.id)),s.treeModel={dataIndx:"caption",checkbox:!1,checkboxHead:!1,cascade:!0,iconCollapse:["fa fa-caret-right","fa fa-caret-down"],summary:!1};var f=s.colModel[s.colModel.length-1];return f&&(f.isLastColumn=!0),s.colModel.push({dataIndx:"empty_column_scroll",title:"",hidden:!0}),s.summaryData=[],s.dataColumnsArray=y,s};
//# sourceMappingURL=BaseClosureTreeTable.task.js.map